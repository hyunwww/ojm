<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="org.ojm.mapper.UserMapper">
	<resultMap type="org.ojm.domain.UserVO" id="userMap">
		<result column="uno" property="uno"/>
		<result column="userid" property="userid"/>
		<result column="userpw" property="userpw"/>
		<result column="username" property="username"/>
		<result column="userbirth" property="userbirth"/>
		<result column="userphone" property="userphone"/>
		<result column="useremail" property="useremail"/>
		<result column="auth" property="auth"/>
		<collection property="info" resultMap="infoMap" />
	</resultMap>
	<resultMap type="org.ojm.domain.InfoVO" id="infoMap">
		<result column="uino" property="uino"/>
		<result column="uno" property="uno"/>
		<result column="nickname" property="nickname"/>
		<result column="uaddress" property="uaddress"/>
		<result column="uads" property="uads"/>
		<result column="ualer" property="ualer"/>
		<result column="ualeretc" property="ualeretc"/>
		<result column="ufavor" property="ufavor"/>
		<result column="ulikestore" property="ulikestore"/>
		<result column="ulikejob" property="ulikejob"/>
		<result column="ugender" property="ugender"/>
	</resultMap>
	<select id="login" parameterType="map" resultMap="userMap">
		select 
			u.userid,u.userpw,u.username,u.userbirth,
			u.userphone,u.useremail,u.auth,i.* 
		from usertable u join userinfo i on u.uno = i.uno 
		where userid=#{id} and userpw=#{pw}
	</select>
	<select id="loginBusiness" resultType="org.ojm.domain.UserVO">
		select * from usertable where userid=#{id} and userpw=#{pw}
	</select>
	<select id="getUser" parameterType="map" resultMap="userMap">
		select 
			u.userid,u.userpw,u.username,u.userbirth,
			u.userphone,u.useremail,u.auth,i.* 
		from usertable u join userinfo i on u.uno = i.uno 
		where userid=#{id} and userpw=#{pw}
	</select>
	
	<insert id="regUser" parameterType="org.ojm.domain.UserVO">
		insert into usertable 
			values(
				seq_uno.nextval,
				#{userid},
				#{userpw},
				#{username},
				#{userphone},
				#{useremail},
				#{auth},
				sysdate
				)
	</insert>
	<insert id="regUserInfo" parameterType="org.ojm.domain.InfoVO">
		insert into userinfo 
			values(
				seq_uino.nextval,
				seq_uno.currval,
				#{nickname},
				#{uaddress},
				#{uads},
				#{ualer},
				#{ualeretc},
				#{ufavor},
				#{ulikestore},
				#{ulikejob},
				#{ugender}
				)
	</insert>
	<update id="modifyUser" parameterType="org.ojm.domain.UserVO">
		update usertable set
			userpw=#{userpw},
			username=#{username},
			userphone=#{userphone},
			useremail=#{useremail}
		where uno=#{uno}
	</update>
	<update id="modifyUserInfo" parameterType="org.ojm.domain.InfoVO">
		update userinfo set
				nickname=#{nickname},
				uaddress=#{uaddress},
				uads=#{uads},
				ualer=#{ualer},
				ualeretc=#{ualeretc},
				ufavor=#{ufavor}
		where uno=#{uno}
	</update>
	<select id="findID" parameterType="map" resultType="String">
		select userid from usertable where username=#{username} and useremail=#{useremail}
	</select>
	
	<!-- 메일인증 -->
	<insert id="newMailKey">
		insert into mail (email,mail_key) values(#{email},#{mail_key})
	</insert>
	
	<update id="updateMailKey">
	   update mail set mail_key=#{mail_key} where email=#{email}
	</update>
	
	<update id="updateMailAuth" >
	   update mail set mail_auth=1 where email=#{email} and mail_key=#{mail_key}
	</update>
</mapper>